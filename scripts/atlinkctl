#!/usr/bin/env python3
"""
atlinkctl â€” minimal CLI to simplify build tasks in the repo

Usage:
  python scripts/atlinkctl install <workspace> [--build-type {Debug,Release}] [--force]
  python scripts/atlinkctl build   <workspace> <component> [--build-type {Debug,Release}] [--force]

Examples:
  python scripts/atlinkctl install ~/Github/atlink --build-type Release
  python scripts/atlinkctl build   ~/Github/atlink tests --build-type Debug
  python scripts/atlinkctl build   ~/Github/atlink examples/linux --force
"""

from __future__ import annotations

import argparse
import shutil
import subprocess
from pathlib import Path
from typing import Sequence


def run(cmd: Sequence[str], cwd: Path | None = None) -> None:
    '''Run a command, printing it first.'''
    print(">>", " ".join(cmd))
    subprocess.run(cmd, cwd=str(cwd) if cwd else None, check=True)


def cmake_configure(source: Path, build: Path, defs: dict[str, str]) -> None:
    '''Run cmake to configure a build directory.'''
    cmd = ["cmake", "-S", str(source), "-B", str(build)]
    for k, v in defs.items():
        cmd.append(f"-D{k}={v}")
    run(cmd)


def cmake_build(build: Path, target: str | None = None) -> None:
    '''Run cmake to build (and optionally target) in a build directory.'''
    cmd = ["cmake", "--build", str(build), "-j"]
    if target:
        cmd += ["--target", target]
    run(cmd)


def is_installed(install_dir: Path) -> bool:
    '''Check if atlink is installed in the given directory.'''
    return (install_dir / "lib" / "cmake" / "atlink" / "atlinkConfig.cmake").is_file()


def ensure_tools() -> None:
    '''Ensure required tools are available.'''
    if shutil.which("cmake") is None:
        raise SystemExit("error: 'cmake' not found in PATH")


def install_atlink(workspace: Path, build_type: str, force: bool) -> None:
    '''Install atlink into workspace/install.'''
    install_dir = workspace / "install"
    if is_installed(install_dir) and not force:
        print(f"==> atlink already installed at {install_dir}")
        return

    print(f"==> Installing atlink (CMAKE_BUILD_TYPE={build_type}) -> {install_dir}")
    build_dir = workspace / "build" / "atlink"
    defs = {
        "CMAKE_BUILD_TYPE": build_type,
        "CMAKE_INSTALL_PREFIX": str(install_dir),
    }
    cmake_configure(workspace / "atlink", build_dir, defs)
    cmake_build(build_dir, target="install")


def build_component(
    workspace: Path, component: str, build_type: str, force: bool
) -> None:
    '''Build a component using the installed atlink.'''
    install_dir = workspace / "install"
    if not is_installed(install_dir) or force:
        if force:
            print("==> --force requested; reinstalling atlink")
        install_atlink(workspace, build_type, force=True)
    else:
        print(f"==> Using installed atlink at {install_dir}")

    comp_src = workspace / component
    if not comp_src.is_dir():
        raise SystemExit(f"error: component path not found: {comp_src}")

    comp_build = workspace / "build" / component
    defs = {
        "CMAKE_BUILD_TYPE": build_type,
        "CMAKE_PREFIX_PATH": str(install_dir),
    }
    print(f"==> Configuring {component} (CMAKE_BUILD_TYPE={build_type})")
    cmake_configure(comp_src, comp_build, defs)
    print(f"==> Building {component}")
    cmake_build(comp_build)


def parse_args() -> argparse.Namespace:
    '''Parse command-line arguments.'''
    p = argparse.ArgumentParser(
        prog="atlinkctl",
        description="Install atlink and build components in an atlink-based repo.",
    )
    sub = p.add_subparsers(dest="cmd", required=True)

    def add_common(sp: argparse.ArgumentParser, need_component: bool) -> None:
        sp.add_argument("workspace", type=Path, help="Path to the repo root")
        if need_component:
            sp.add_argument(
                "component",
                help="Relative path under workspace (e.g. tests, examples/linux)",
            )
        sp.add_argument(
            "--build-type",
            choices=["Debug", "Release"],
            default="Debug",
            help="CMAKE_BUILD_TYPE (default: Debug)",
        )
        sp.add_argument(
            "--force", action="store_true", help="Force reinstall of atlink"
        )

    add_common(
        sub.add_parser("install", help="Install atlink into ./install"),
        need_component=False,
    )
    add_common(
        sub.add_parser("build", help="Build a component using installed atlink"),
        need_component=True,
    )

    return p.parse_args()


def main() -> None:
    '''Main entry point.'''
    ensure_tools()
    args = parse_args()

    workspace: Path = args.workspace.resolve()
    if not workspace.is_dir():
        raise SystemExit(f"error: workspace not found: {workspace}")

    if args.cmd == "install":
        install_atlink(workspace, args.build_type, args.force)
    elif args.cmd == "build":
        build_component(workspace, args.component, args.build_type, args.force)
    else:
        raise SystemExit("unhandled subcommand")


if __name__ == "__main__":
    main()
